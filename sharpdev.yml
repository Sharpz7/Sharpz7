version: 1

envfile: .env

scripts:
  login: |
    docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD

  image: |
    sharpdev login
    docker build --network=host -t sharp6292/coder-base -f dockerfiles/coder.Dockerfile .
    docker push sharp6292/coder-base

    docker build --network=host -t sharp6292/coder-gpu -f dockerfiles/gpu.Dockerfile .
    docker push sharp6292/coder-gpu

    docker build --network=host -t sharp6292/envbuilder -f dockerfiles/envbuilder.Dockerfile .
    docker push sharp6292/envbuilder

  gcp_template: |
    coder template create --var project_id=alberta-389816

  gcp-install: |
    curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-444.0.0-linux-x86_64.tar.gz
    tar -xf google-cloud-cli-444.0.0-linux-x86_64.tar.gz
    apk add python3
    ./google-cloud-sdk/install.sh

    # Start new shell
    gcloud auth application-default login

  cc-template: |
    coder template push --var encoded_ssh_private_key=$(base64 -w0 compute-canada.ssh)